# coding=utf-8
from pytg.sender import Sender
from pytg.receiver import Receiver
from pytg.utils import coroutine
from collections import deque
from time import time, sleep
from getopt import getopt
import sys
import datetime as dt
import re
import _thread
import random

# username –∏–≥—Ä–æ–≤–æ–≥–æ –±–æ—Ç–∞
bot_username = 'ChatWarsBot'

stock_bot = 'WarChatsEquip_bot'

# –≤–∞—à username –∏–ª–∏ username —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç—É
admin_username = ''

# username –±–æ—Ç–∞ –∏/–∏–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–∫–∞–∑—ã
order_usernames = ''

# –∏–º—è –∑–∞–º–∫–∞
castle_name = 'blue'

captcha_bot = 'ChatWarsCaptchaBot'

# —Ö–æ—Å—Ç —á—Ç–æ–± —Å–ª—É—à–∞—Ç—å telegram-cli
host = 'localhost'

# –ø–æ—Ä—Ç –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Å–ª—É—à–∞—Ç—å
port = 1338

opts, args = getopt(sys.argv[1:], 'a:o:c:s:h:p', ['admin=', 'order=', 'castle=', 'socket=', 'host=', 'port='])

for opt, arg in opts:
    if opt in ('-a', '--admin'):
        admin_username = arg
    elif opt in ('-o', '--order'):
        order_usernames = arg.split(',')
    elif opt in ('-c', '--castle'):
        castle_name = arg
    elif opt in ('-s', '--socket'):
        socket_path = arg
    elif opt in ('-h', '--host'):
        host = arg
    elif opt in ('-p', '--port'):
        port = int(arg)

orders = {
    'red': 'üáÆüá≤',
    'black': 'üá¨üáµ',
    'white': 'üá®üáæ',
    'yellow': 'üáªüá¶',
    'blue': 'üá™üá∫',
    'lesnoi_fort': 'üå≤–õ–µ—Å–Ω–æ–π —Ñ–æ—Ä—Ç',
    'les': 'üå≤–õ–µ—Å',
    'gorni_fort': '‚õ∞–ì–æ—Ä–Ω—ã–π —Ñ–æ—Ä—Ç',
    'gora': '‚õ∞',
    'cover': 'üõ° –ó–∞—â–∏—Ç–∞',
    'attack': '‚öî –ê—Ç–∞–∫–∞',
    'cover_symbol': 'üõ°',
    'hero': 'üèÖ–ì–µ—Ä–æ–π',
    'corovan': '/go',
    'peshera': 'üï∏–ü–µ—â–µ—Ä–∞',
    'taverna': 'üç∫–í–∑—è—Ç—å –∫—Ä—É–∂–∫—É —ç–ª—è'
}

captcha_answers = {
    'watermelon_n_cherry': 'üçâüçí',
    'bread_n_cheese': 'üçûüßÄ',
    'cheese': 'üßÄ',
    'pizza': 'üçï',
    'hotdog': 'üå≠',
    'eggplant_n_carrot': 'üçÜü•ï',
    'dog': 'üêï',
    'horse': 'üêé',
    'goat': 'üêê',
    'cat': 'üêà',
    'pig': 'üêñ',
    'squirrel': 'üêø'
}

states_map = {
    'relax': 'üõå–û—Ç–¥—ã—Ö',
    'defense': 'üõ°–ó–∞—â–∏—Ç–∞',
    'attack': '‚öî–ê—Ç–∞–∫–∞',
    'arena': 'üìØ–ù–∞ –∞—Ä–µ–Ω–µ',
    'les': 'üå≤–í –ª–µ—Å—É',
    'peshera': 'üï∏–í –ø–µ—â–µ—Ä–µ',
    'taverna': 'üç∫–ü—å–µ—à—å –≤ —Ç–∞–≤–µ—Ä–Ω–µ'
}

arena_cover = ['üõ°–≥–æ–ª–æ–≤—ã', 'üõ°–∫–æ—Ä–ø—É—Å–∞', 'üõ°–Ω–æ–≥']
arena_attack = ['üó°–≤ –≥–æ–ª–æ–≤—É', 'üó°–ø–æ –∫–æ—Ä–ø—É—Å—É', 'üó°–ø–æ –Ω–æ–≥–∞–º']
# –ø–æ–º–µ–Ω—è—Ç—å blue –Ω–∞ red, black, white, yellow –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –∑–∞–º–∫–∞
castle = orders[castle_name]
# —Ç–µ–∫—É—â–∏–π –ø—Ä–∏–∫–∞–∑ –Ω–∞ –∞—Ç–∞–∫—É/–∑–∞—â–∏—Ç—É, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ–≥–¥–∞ –∑–∞—â–∏—Ç–∞, —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
current_order = {'time': 0, 'order': castle}

sender = Sender(host=host, port=port)
action_list = deque([])
log_list = deque([], maxlen=30)
get_info_diff = 360
hero_message_id = 0
last_captcha_id = 0

enabled_list = {
    'bot': True,
    'arena': True,
    'taverna': True,
    'les': True,
    'peshera': False,
    'corovan': True,
    'order': True,
    'auto_def': True,
    'donate': False,
    'sell': True
}

last_time = {
    'info': time() - 60*60,
    'arena': time() - 60*60,
    'sell': time() - 60*60
}

@coroutine
def work_with_message(receiver):
    while True:
        msg = (yield)
        try:
            if msg['event'] == 'message' and 'text' in msg and msg['peer'] is not None \
                    and int(time()+1) - int(msg['date']) < 5:
                parse_text(msg['text'], msg['sender']['username'], msg['id'])
        except Exception as err:
            log('–û—à–∏–±–∫–∞ coroutine: {0}'.format(err))


def queue_worker():
    global get_info_diff
    global last_time
    sender.dialog_list()
    sleep(3)
    while True:
        try:

            if time() - last_time['info'] > get_info_diff:
                last_time['info'] = time()
                get_info_diff = random.randint(400, 600)
                if enabled_list['bot']:
                    send_msg(bot_username, orders['hero'])
                continue

            if len(action_list):
                log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ' + action_list[0])
                send_msg(bot_username, action_list.popleft())
            sleep_time = random.randint(2, 6)
            sleep(sleep_time)
        except Exception as err:
            log('–û—à–∏–±–∫–∞ –æ—á–µ—Ä–µ–¥–∏: {0}'.format(err))


def parse_text(text, username, message_id):
    global last_time
    global hero_message_id
    global enabled_list
    global last_captcha_id
    if username == bot_username:
        log('–ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è')

        if "–ù–∞ –≤—ã—Ö–æ–¥–µ –∏–∑ –∑–∞–º–∫–∞ –æ—Ö—Ä–∞–Ω–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç" in text:
            with open('captcha.txt', 'a+') as f:
                f.seek(0)
                for line in f:
                    if text in line:
                        break
                else:
                    f.write(text + '\n' + '-' * 8 + '\n')

            action_list.clear()
            last_captcha_id = message_id
            fwd(captcha_bot, message_id)
            enabled_list['bot'] = False

        elif '–ù–µ —É–º–Ω–∏—á–∞–π!' in text or '–¢—ã –¥–æ–ª–≥–æ –¥—É–º–∞–ª, –∞–∂ –≤—Å–ø–æ—Ç–µ–ª –æ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è' in text or '–ù–µ —à—É—Ç–∏ —Å–æ —Å—Ç—Ä–∞–∂–Ω–∏–∫–∞–º–∏' in text:
            send_msg(admin_username, "–ö–æ–º–∞–Ω–¥–∏—Ä, —É –Ω–∞—Å –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞–ø—á–æ–π! #captcha " + '|'.join(captcha_answers.keys()))
            enabled_list['bot'] = False
            if last_captcha_id != 0:
                fwd(admin_username, last_captcha_id)
            else:
                send_msg(admin_username, '–ö–∞–ø—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞?')

        elif '–¢—ã —Å–ª–∏—à–∫–æ–º —É—Å—Ç–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫–æ–≥–¥–∞ –æ—Ç–¥–æ—Ö–Ω–µ—à—å.' in text:
            send_msg(admin_username, "–ù–µ —É–≥–∞–¥–∞–ª–∏ —Å –∫–∞–ø—á–µ–π, –≤—ã—Ä—É–±–∞—é –±–æ—Ç–∞")
            enabled_list['bot'] = False

        elif '–¢—ã –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ' in text:
            enabled_list['bot'] = True

        if enabled_list['bot']:
            if enabled_list['corovan'] and text.find(' /go') != -1:
                action_list.append(orders['corovan'])

            elif text.find('–°—Ä–∞–∂–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –Ω–µ —á–∞—â–µ —á–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≤ —á–∞—Å.') != -1:
                last_time['arena'] = time() - 15 * 60
                last_time['info'] = time()
                action_list.append(orders['hero'])

            elif text.find('[–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é]') != -1 and enabled_list['sell']:
                enabled_list['sell'] = False
                send_msg(admin_username, '–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –Ω–∏—Ç–∫–∏ :(')

            elif text.find('–ë–∏—Ç–≤–∞ –ø—è—Ç–∏ –∑–∞–º–∫–æ–≤ —á–µ—Ä–µ–∑') != -1:
                last_time['info'] = time()
                hero_message_id = message_id
                m = re.search('–ë–∏—Ç–≤–∞ –ø—è—Ç–∏ –∑–∞–º–∫–æ–≤ —á–µ—Ä–µ–∑(?: ([0-9]+)—á){0,1}(?: ([0-9]+)){0,1}', text)
                state = re.search('–°–æ—Å—Ç–æ—è–Ω–∏–µ:\\n(.*)\\n', text)
                if not m.group(1):
                    if m.group(2) and int(m.group(2)) <= 30:
                        if enabled_list['auto_def'] and time() - current_order['time'] > 3600:
                            if enabled_list['donate']:
                                gold = int(re.search('üí∞([0-9]+)', text).group(1))
                                log('–î–æ–Ω–∞—Ç {0} –∑–æ–ª–æ—Ç–∞ –≤ –∫–∞–∑–Ω—É –∑–∞–º–∫–∞'.format(gold))
                                action_list.append('/donate {0}'.format(gold))
                            update_order(castle)
                        return
                if states_map['relax'] not in state.group(1) and states_map['defense'] not in state.group(1) and \
                                states_map['attack'] not in state.group(1):
                    return

                log('–í—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ')
                gold = int(re.search('üí∞([0-9]+)', text).group(1))
                endurance = int(re.search('–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: ([0-9]+)', text).group(1))
                log('–ó–æ–ª–æ—Ç–æ: {0}, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {1}'.format(gold, endurance))

                if text.find('/level_up') != -1 and '/level_up' not in action_list:
                    damage = int(re.search('–ê—Ç–∞–∫–∞: ([0-9]+)', text).group(1))
                    defence = int(re.search('–ó–∞—â–∏—Ç–∞: ([0-9]+)', text).group(1))
                    action_list.append('/level_up')
                    log('level_up')
                    if damage > defence:
                        action_list.append('+1 ‚öî–ê—Ç–∞–∫–∞')
                    else:
                        action_list.append('+1 üõ°–ó–∞—â–∏—Ç–∞')

                if enabled_list['peshera'] and endurance >= 2 and orders['peshera'] not in action_list:
                    action_list.append(orders['peshera'])

                elif enabled_list['les'] and endurance >= 1 and orders['les'] not in action_list:
                    action_list.append(orders['les'])

                elif enabled_list['arena'] and 'üîé–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞' not in action_list and time() - last_time['arena'] > 3600:
                    if gold >= 5:
                        action_list.append('üîé–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞')
                    elif enabled_list['sell'] and time() - last_time['sell'] > 3000:
                        action_list.append('/s_101 ' + str((6 - gold) // 2))
                        last_time['sell'] = time()
                        action_list.append('üîé–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞')

                elif enabled_list['taverna'] and gold >= 20 and orders['taverna'] not in action_list and \
                        (dt.datetime.now().time() >= dt.time(19) or dt.datetime.now().time() < dt.time(6)):
                    action_list.append(orders['taverna'])

            elif enabled_list['arena'] and text.find('–≤—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É –∞—Ç–∞–∫–∏ –∏ —Ç–æ—á–∫—É –∑–∞—â–∏—Ç—ã') != -1:
                last_time['arena'] = time()
                attack_chosen = arena_attack[random.randint(0, 2)]
                cover_chosen = arena_cover[random.randint(0, 2)]
                log('–ê—Ç–∞–∫–∞: {0}, –ó–∞—â–∏—Ç–∞: {1}'.format(attack_chosen, cover_chosen))
                action_list.append(attack_chosen)
                action_list.append(cover_chosen)

            elif text.find('–ü–æ–±–µ–¥–∏–ª –≤–æ–∏–Ω') != -1:
                fwd('BlueOysterBot', message_id)

            elif text.find('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–ª–∞–¥–∞') != -1:
                fwd(stock_bot, message_id)

            elif "–•–æ—Ä–æ—à–æ!" not in text and "–•–æ—Ä–æ—à–∏–π –ø–ª–∞–Ω" not in text and "5 –º–∏–Ω—É—Ç" not in text and \
                            "–¢—ã —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç" not in text and "–í–µ—Ç–µ—Ä –∑–∞–≤—ã–≤–∞–µ—Ç" not in text and \
                            "–°–æ–ø–µ—Ä–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω" not in text and "–°–∏–Ω–∏–π –∑–∞–º–æ–∫" not in text and \
                            "–°–∏–Ω–µ–≥–æ –∑–∞–º–∫–∞" not in text and "–û–±—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∑–∞–º–∫–∞" not in text and \
                            "–ü–æ–±–µ–¥–∏–ª –≤–æ–∏–Ω" not in text and not re.findall(r'\b–Ω–∞–Ω–µ—Å\b(.*)\b—É–¥–∞—Ä\b', text):
                with open('taverna.txt', 'a+') as f:
                    f.seek(0)
                    for line in f:
                        if text[0:8] in line:
                            break
                    else:
                        f.write(text + '\n')
                action_list.append(orders['hero'])
                last_time['info'] = time()

    elif username == 'ChatWarsCaptchaBot':
        if len(text) <= 4 and text in captcha_answers.values():
            sleep(3)
            action_list.clear()
            action_list.append(text)
            enabled_list['bot'] = True

    else:
        if enabled_list['bot'] and enabled_list['order'] and username in order_usernames:
            if text.find(orders['red']) != -1:
                update_order(orders['red'])
            elif text.find(orders['black']) != -1:
                update_order(orders['black'])
            elif text.find(orders['white']) != -1:
                update_order(orders['white'])
            elif text.find(orders['yellow']) != -1:
                update_order(orders['yellow'])
            elif text.find(orders['blue']) != -1:
                update_order(orders['blue'])
            elif text.find('üå≤') != -1:
                update_order(orders['lesnoi_fort'])
            elif text.find('‚õ∞') != -1:
                update_order(orders['gorni_fort'])
            elif text.find('üõ°') != -1:
                update_order(castle)

                # send_msg(admin_username, '–ü–æ–ª—É—á–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É ' + current_order['order'] + ' –æ—Ç ' + username)
        if username == "Telegram":
            fwd(admin_username, message_id)

        if username == admin_username:
            if text == '#help':
                send_msg(admin_username, '\n'.join([
                    '#enable_bot - –í–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞',
                    '#disable_bot - –í—ã–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞',
                    '#enable_arena - –í–∫–ª—é—á–∏—Ç—å –∞—Ä–µ–Ω—É',
                    '#disable_arena - –í—ã–∫–ª—é—á–∏—Ç—å –∞—Ä–µ–Ω—É',
                    '#disable_taverna - –í—ã–∫–ª—é—á–∏—Ç—å —Ç–∞–≤–µ—Ä–Ω—É',
                    '#enable_taverna - –í–∫–ª—é—á–∏—Ç—å —Ç–∞–≤–µ—Ä–Ω—É',
                    '#enable_sell - –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É –Ω–∏—Ç–æ–∫',
                    '#disable_sell - –í—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É –Ω–∏—Ç–æ–∫',
                    '#enable_les - –í–∫–ª—é—á–∏—Ç—å –ª–µ—Å',
                    '#disable_les - –í—ã–∫–ª—é—á–∏—Ç—å –ª–µ—Å',
                    '#enable_peshera - –í–∫–ª—é—á–∏—Ç—å –ø–µ—â–µ—Ä—ã',
                    '#disable_peshera - –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—â–µ—Ä—ã',
                    '#enable_corovan - –í–∫–ª—é—á–∏—Ç—å –∫–æ—Ä–æ–≤–∞–Ω',
                    '#disable_corovan - –í—ã–∫–ª—é—á–∏—Ç—å –∫–æ—Ä–æ–≤–∞–Ω',
                    '#enable_order - –í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–∫–∞–∑—ã',
                    '#disable_order - –í—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–∫–∞–∑—ã',
                    '#enable_auto_def - –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ –¥–µ—Ñ',
                    '#disable_auto_def - –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ –¥–µ—Ñ',
                    '#enable_donate - –í–∫–ª—é—á–∏—Ç—å –¥–æ–Ω–∞—Ç',
                    '#disable_donate - –í—ã–∫–ª—é—á–∏—Ç—å –¥–æ–Ω–∞—Ç',
                    '#update_stock - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–æ–∫',
                    '#status - –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å',
                    '#hero - –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–µ—Ä–æ–µ',
                    '#push_order - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∫–∞–∑ ({0})'.format(','.join(orders)),
                    '#order - –î–µ–±–∞–≥, –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞—â–∏—Ç—ã/–∞—Ç–∞–∫–∏ –∑–∞–º–∫–∞',
                    '#log - –î–µ–±–∞–≥, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ª–æ–≥–∞',
                    '#time - –î–µ–±–∞–≥, —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è',
                    '#last_time[...] - –î–µ–±–∞–≥, –ø–æ—Å–ª–µ–¥–Ω—è—è –±–∏—Ç–≤–∞ –Ω–∞ –∞—Ä–µ–Ω–µ',
                    '#get_info_diff - –î–µ–±–∞–≥, –ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–µ—Ä–æ–µ',
                    '#ping - –î–µ–±–∞–≥, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∂–∏–≤ –ª–∏ –±–æ—Ç',
                ]))

            # –í–∫–ª/–≤—ã–∫–ª –±–æ—Ç–∞
            elif text == '#enable_bot':
                enabled_list['bot'] = True
                send_msg(admin_username, '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_bot':
                enabled_list['bot'] = False
                send_msg(admin_username, '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            elif text == '#enable_sell':
                enabled_list['sell'] = True
                send_msg(admin_username, '–ü—Ä–æ–¥–∞–∂–∞ –Ω–∏—Ç–æ–∫ –≤–ª—é—á–µ–Ω–∞')
            elif text == '#disable_sell':
                enabled_list['sell'] = False
                send_msg(admin_username, '–ü—Ä–æ–¥–∞–∂–∞ –Ω–∏—Ç–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω–∞')

            # –í–∫–ª/–≤—ã–∫–ª –∞—Ä–µ–Ω—ã
            elif text == '#enable_arena':
                enabled_list['arena'] = True
                send_msg(admin_username, '–ê—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞')
            elif text == '#disable_arena':
                enabled_list['arena'] = False
                send_msg(admin_username, '–ê—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–∞')

            # –í–∫–ª/–≤—ã–∫–ª —Ç–∞–≤–µ—Ä–Ω—ã
            elif text == '#enable_taverna':
                enabled_list['taverna'] = True
                send_msg(admin_username, '–¢–∞–≤–µ—Ä–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞')
            elif text == '#disable_taverna':
                enabled_list['taverna'] = False
                send_msg(admin_username, '–¢–∞–≤–µ—Ä–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–∞')

            # –í–∫–ª/–≤—ã–∫–ª –ª–µ—Å–∞
            elif text == '#enable_les':
                enabled_list['les'] = True
                send_msg(admin_username, '–õ–µ—Å —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_les':
                enabled_list['les'] = False
                send_msg(admin_username, '–õ–µ—Å —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –ø–µ—â–µ—Ä—ã
            elif text == '#enable_peshera':
                enabled_list['peshera'] = True
                send_msg(admin_username, '–ü–µ—â–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞')
            elif text == '#disable_peshera':
                enabled_list['peshera'] = False
                send_msg(admin_username, '–ü–µ—â–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–∞')

            # –í–∫–ª/–≤—ã–∫–ª –∫–æ—Ä–æ–≤–∞–Ω–∞
            elif text == '#enable_corovan':
                enabled_list['corovan'] = True
                send_msg(admin_username, '–ö–æ—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã')
            elif text == '#disable_corovan':
                enabled_list['corovan'] = False
                send_msg(admin_username, '–ö–æ—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω—ã')

            # –í–∫–ª/–≤—ã–∫–ª –∫–æ–º–∞–Ω–¥
            elif text == '#enable_order':
                enabled_list['order'] = True
                send_msg(admin_username, '–ü—Ä–∏–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã')
            elif text == '#disable_order':
                enabled_list['order'] = False
                send_msg(admin_username, '–ü—Ä–∏–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω—ã')

            # –í–∫–ª/–≤—ã–∫–ª –∞–≤—Ç–æ –¥–µ—Ñ
            elif text == '#enable_auto_def':
                enabled_list['auto_def'] = True
                send_msg(admin_username, '–ê–≤—Ç–æ –¥–µ—Ñ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_auto_def':
                enabled_list['auto_def'] = False
                send_msg(admin_username, '–ê–≤—Ç–æ –¥–µ—Ñ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –∞–≤—Ç–æ –¥–æ–Ω–∞—Ç
            elif text == '#enable_donate':
                enabled_list['donate'] = True
                send_msg(admin_username, '–î–æ–Ω–∞—Ç —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_donate':
                enabled_list['donate'] = False
                send_msg(admin_username, '–î–æ–Ω–∞—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            elif text == '#update_stock':
                action_list.append('/stock')

            # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            elif text == '#status':
                send_msg(admin_username, '\n'.join([
                    '–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω: {0}',
                    '–ê—Ä–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞: {1}',
                    '–õ–µ—Å –≤–∫–ª—é—á–µ–Ω: {2}',
                    '–ü–µ—â–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞: {3}',
                    '–ö–æ—Ä–æ–≤–∞–Ω—ã –≤–∫–ª—é—á–µ–Ω—ã: {4}',
                    '–ü—Ä–∏–∫–∞–∑—ã –≤–∫–ª—é—á–µ–Ω—ã: {5}',
                    '–ê–≤—Ç–æ –¥–µ—Ñ –≤–∫–ª—é—á–µ–Ω: {6}',
                    '–î–æ–Ω–∞—Ç –≤–∫–ª—é—á–µ–Ω: {7}',
                    '–¢–∞–≤–µ—Ä–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞: {8}',
                    '–ü—Ä–æ–¥–∞–∂–∞ –Ω–∏—Ç–æ–∫: {9}',
                ]).format(enabled_list['bot'], enabled_list['arena'], enabled_list['les'], enabled_list['peshera'], enabled_list['corovan'], enabled_list['order'],
                          enabled_list['auto_def'], enabled_list['donate'], enabled_list['taverna'], enabled_list['sell']))

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ–µ
            elif text == '#hero':
                if hero_message_id == 0:
                    send_msg(admin_username, '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ–µ –ø–æ–∫–∞ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')
                else:
                    fwd(admin_username, hero_message_id)

            # –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥
            elif text == '#log':
                send_msg(admin_username, '\n'.join(log_list))
                log_list.clear()

            elif text == '#last_time':
                send_msg(admin_username, str(dt.datetime.fromtimestamp(last_time['arena']).time()))

            elif text == '#order':
                text_date = str(dt.datetime.fromtimestamp(current_order['time']).time())
                send_msg(admin_username, current_order['order'] + ' ' + text_date)

            elif text == '#time':
                text_date = str(dt.datetime.now().time())
                send_msg(admin_username, text_date)

            elif text == '#ping':
                send_msg(admin_username, '#pong')

            elif text == '#get_info_diff':
                send_msg(admin_username, str(get_info_diff))

            elif text.startswith('#push_order'):
                command = text.split(' ')[1]
                if command in orders:
                    update_order(orders[command])
                    send_msg(admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –ø—Ä–∏–º–µ–Ω–µ–Ω–∞')
                else:
                    send_msg(admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞')

            elif text.startswith('#captcha'):
                command = text.split(' ')[1]
                if command in captcha_answers:
                    action_list.clear()
                    action_list.append(captcha_answers[command])
                    enabled_list['bot'] = True
                    send_msg(admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –ø—Ä–∏–º–µ–Ω–µ–Ω–∞')
                else:
                    send_msg(admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞')


def send_msg(to, message):
    sender.mark_read('@' + to)
    sender.send_msg('@' + to, message)


def fwd(to, message_id):
    sender.fwd('@' + to, message_id)


def update_order(order):
    current_order['order'] = order
    current_order['time'] = time()
    if order == castle:
        action_list.append(orders['cover'])
    else:
        action_list.append(orders['attack'])
    action_list.append(order)


def log(text):
    message = '{0:%Y-%m-%d %H:%M:%S}'.format(dt.datetime.now()) + ' ' + text
    print(message)
    log_list.append(message)


if __name__ == '__main__':
    receiver = Receiver(port=port)
    receiver.start()
    _thread.start_new_thread(queue_worker, ())
    receiver.message(work_with_message(receiver))
    receiver.stop()
